pipeline {
  agent any

  environment {
    AWS_REGION = "ap-northeast-2"

    // ECR (game)
    ECR_REPO_URI = "269397878198.dkr.ecr.ap-northeast-2.amazonaws.com/t3-wagu-game-server"

    // waguwagu-infra
    INFRA_REPO_URL = "https://github.com/ms-waguwagu/waguwagu-infra.git"
    INFRA_BRANCH   = "main"

    // ë°”ê¿€ manifest (agones fleet)
    INFRA_AGONES_FLEET_MANIFEST = "k8s/agones/agones-fleet.yaml"
    

    // Secrets Manager (PAT)
    GH_SECRET_ID  = "T3-Wagu-Secrets"
    GH_SECRET_KEY = "GITHUB_PAT"

    // Git author
    GIT_USER_NAME  = "jenkins-bot"
    GIT_USER_EMAIL = "jenkins@waguwagu.local"
  }

  options {
    skipDefaultCheckout(true)
  }

  stages {
    stage("Checkout") {
      steps { checkout scm }
    }

    stage("Change check (game-server only)") {
      steps {
        script {
          echo "=== GAME JENKINSFILE ==="

          def base  = env.GIT_PREVIOUS_SUCCESSFUL_COMMIT ?: env.GIT_PREVIOUS_COMMIT
          env.DIFF_RANGE = base ? "${base}..HEAD" : "HEAD~1..HEAD"
          echo "Diff range: ${env.DIFF_RANGE}"

          //  game-server ë³€ê²½ë§Œ, Jenkinsfileë§Œ ë°”ë€ ê±´ ì œì™¸
          def changed = sh(
            script: '''#!/usr/bin/env bash
              set -e
              git diff --name-only ${range} \\
                | grep -E '^game-server/' \\
                | grep -v '^game-server/Jenkinsfile\\\\\$' \\
                || true
            ''',
            returnStdout: true
          ).trim()

          if (!changed) {
            echo "No app changes in game-server/ -> SKIP"
            env.GAME_CHANGED = "false"
          } else {
            echo "Changes detected -> proceed."
            echo "Changed files:\n${changed}"
            env.GAME_CHANGED = "true"
          }
        }
      }
    }

    stage("ECR Login") {
      when { expression { env.GAME_CHANGED == "true" } }
      steps {
        sh '''
          set -e
          aws ecr get-login-password --region "${AWS_REGION}" \
            | docker login --username AWS --password-stdin "${ECR_REPO_URI%/*}"
        '''
      }
    }

    stage("Build & Push") {
      when { expression { env.GAME_CHANGED == "true" } }
      steps {
        script {
          def sha7 = sh(returnStdout: true, script: "git rev-parse --short=7 HEAD").trim()
          env.IMAGE_TAG = "${sha7}-${env.BUILD_NUMBER}"
          env.IMAGE_URI = "${env.ECR_REPO_URI}:${env.IMAGE_TAG}"
          echo "IMAGE_URI = ${env.IMAGE_URI}"
        }

        sh '''
          set -e
          cd game-server
          docker build -t "${ECR_REPO_URI}:${IMAGE_TAG}" .
          docker push "${ECR_REPO_URI}:${IMAGE_TAG}"
        '''
      }
    }

    stage("Update waguwagu-infra manifest (commit/push)") {
      when { expression { env.GAME_CHANGED == "true" } }
      steps {
        sh '''
          set -euo pipefail

          rm -rf infra
          mkdir -p infra

          git config --global user.name  "${GIT_USER_NAME}"
          git config --global user.email "${GIT_USER_EMAIL}"

          # credential helper ê¼¬ì„ ë°©ì§€
          git config --global --unset-all credential.helper || true
          git config --global credential.helper ""

          # ğŸ”’ í† í°/í—¤ë” êµ¬ê°„ ë¡œê·¸ ìˆ¨ê¹€
          set +x
          TOK="$(aws secretsmanager get-secret-value \
              --secret-id "${GH_SECRET_ID}" \
              --region "${AWS_REGION}" \
              --query SecretString \
              --output text \
              | jq -r --arg k "${GH_SECRET_KEY}" '.[$k]' \
              | tr -d '\r\n')"

          AUTH="$(printf 'x-access-token:%s' "$TOK" | base64 | tr -d '\n')"
          EXTRA="http.https://github.com/.extraheader=AUTHORIZATION: basic $AUTH"

          GIT_TERMINAL_PROMPT=0 git -c "$EXTRA" clone --branch "${INFRA_BRANCH}" "${INFRA_REPO_URL}" infra
          cd infra
          set -x

          echo "[BEFORE] image line:"
          grep -n "image:.*${ECR_REPO_URI}:" "${INFRA_AGONES_FLEET_MANIFEST}" || true

          sed -i "s#\\(image:[[:space:]]*${ECR_REPO_URI}:\\).*#\\1${IMAGE_TAG}#g" "${INFRA_AGONES_FLEET_MANIFEST}"

          echo "[AFTER] image line:"
          grep -n "image:.*${ECR_REPO_URI}:" "${INFRA_AGONES_FLEET_MANIFEST}" || true

          if git diff --quiet; then
            echo "No manifest change (already on ${IMAGE_TAG}). Skip commit/push."
            exit 0
          fi

          git add "${INFRA_AGONES_FLEET_MANIFEST}"
          git commit -m "ci(game): bump image to ${IMAGE_TAG}"

          set +x
          GIT_TERMINAL_PROMPT=0 git -c "$EXTRA" push origin HEAD:"${INFRA_BRANCH}"
          set -x
        '''
      }
    }
  }

  post {
    always {
      sh 'docker image prune -f || true'
    }
  }
}



/* ì¼ë‹¨ ì£¼ì„ 
pipeline {
  agent any

  environment {
    AWS_REGION   = "ap-northeast-2"

    //game ECR URI ì¼ë‹¨ ë‚´ ê³„ì • accountid / ë‹¤ì‹œ ë°”ê¿ˆ 
    ECR_REPO_URI = "061039804626.dkr.ecr.ap-northeast-2.amazonaws.com/t3-wagu-game-server"

    CLUSTER_NAME = "T3-Wagu-Game-EKS"
    NAMESPACE    = "game"

    // Agones Fleet
    FLEET_NAME   = "waguwagu-fleet"
    CONTAINER_NAME = "game-server"
  }

  options {
    skipDefaultCheckout(true)
    // (ì˜µì…˜) ì¤‘ë³µ checkout ë°©ì§€í•˜ê³  ì‹¶ìœ¼ë©´ ì¼œë„ ë¨
    // skipDefaultCheckout(true)
  }

  stages {
    stage("Checkout") {
      steps {
        checkout scm
      }
    }

    // (ì„ íƒ) game-server í´ë” ë³€ê²½ ì²´í¬ (í•˜ì§€ë§Œ ì´ì œ ìŠ¤í‚µ/ì¤‘ë‹¨ ì•ˆ í•¨)
    stage("Change check") {
      steps {
        script {
          def changed = sh(
            script: "git diff --name-only HEAD~1..HEAD | grep -E '^game-server/' || true",
            returnStdout: true
          ).trim()

          // ë³€ê²½ ì—†ì–´ë„ ë¹Œë“œë¥¼ ë§‰ì§€ ë§ê³  ê·¸ëƒ¥ ì§„í–‰
          if (!changed) {
            echo "No changes in game-server/, but continue (always Build & Push)."
          } else {
            echo "Changes detected in game-server/ -> proceed."
          }
        }
      }
    }

    stage("ECR Login") {
      steps {
        sh '''
          set -e
          aws ecr get-login-password --region ${AWS_REGION} \
            | docker login --username AWS --password-stdin ${ECR_REPO_URI%/*}
        '''
      }
    }

    stage("Build & Push") {
      steps {
        script {
          // env.GIT_COMMITì´ nullë¡œ ë“¤ì–´ì˜¤ëŠ” Jenkinsê°€ ìˆì–´ì„œ gitìœ¼ë¡œ ì§ì ‘ ë½‘ì•„ ì•ˆì •í™”
          def sha7 = sh(returnStdout: true, script: "git rev-parse --short=7 HEAD").trim()
          def tag = "${sha7}-${env.BUILD_NUMBER}"
          env.IMAGE_TAG = tag
          env.IMAGE_URI = "${env.ECR_REPO_URI}:${tag}"
          echo "IMAGE_URI = ${env.IMAGE_URI}"
        }

        sh '''
          set -e
          cd game-server
          docker build -t ${ECR_REPO_URI}:${IMAGE_TAG} .
          docker push ${ECR_REPO_URI}:${IMAGE_TAG}
        '''
      }
    }

  }

  post {
    always {
      sh 'docker image prune -f || true'
    }
  }
}
*/ 











