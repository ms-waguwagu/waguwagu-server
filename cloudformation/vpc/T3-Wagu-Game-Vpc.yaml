AWSTemplateFormatVersion: "2010-09-09"
Description:
  T3-Wagu Game VPC with Public, Private Subnets and VPC Peering to Matching VPC

Parameters:
  ProjectPrefix:
    Type: String
    Default: T3-Wagu

  MatchingVPCCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: CIDR block of T3-Wagu-Matching-VPC

Resources:

# =====================
# Game VPC
# =====================
  GameVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.1.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: T3-Wagu-Game-VPC

# =====================
# Internet Gateway
# =====================
  GameInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: T3-Wagu-Game-IGW

  GameIGWAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref GameVPC
      InternetGatewayId: !Ref GameInternetGateway

# =====================
# Public Subnets
# =====================
  GamePublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref GameVPC
      CidrBlock: 10.1.10.0/24
      AvailabilityZone: ap-northeast-2a
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: T3-Wagu-Game-Public-Subnet-A
        - Key: kubernetes.io/cluster/T3-Wagu-Game
          Value: shared
        - Key: kubernetes.io/role/elb
          Value: 1

  GamePublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref GameVPC
      CidrBlock: 10.1.11.0/24
      AvailabilityZone: ap-northeast-2c
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: T3-Wagu-Game-Public-Subnet-B
        - Key: kubernetes.io/cluster/T3-Wagu-Game
          Value: shared
        - Key: kubernetes.io/role/elb
          Value: 1

# =====================
# Private Subnets
# =====================
  GamePrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref GameVPC
      CidrBlock: 10.1.20.0/24
      AvailabilityZone: ap-northeast-2a
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: T3-Wagu-Game-Private-Subnet-A
        - Key: kubernetes.io/cluster/T3-Wagu-Game
          Value: shared
        - Key: kubernetes.io/role/internal-elb
          Value: 1

  GamePrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref GameVPC
      CidrBlock: 10.1.21.0/24
      AvailabilityZone: ap-northeast-2c
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: T3-Wagu-Game-Private-Subnet-B
        - Key: kubernetes.io/cluster/T3-Wagu-Game
          Value: shared
        - Key: kubernetes.io/role/internal-elb
          Value: 1

# =====================
# Public Route Table
# =====================
  GamePublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref GameVPC
      Tags:
        - Key: Name
          Value: T3-Wagu-Game-Public-RT

  GamePublicRoute:
    Type: AWS::EC2::Route
    DependsOn: GameIGWAttachment
    Properties:
      RouteTableId: !Ref GamePublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref GameInternetGateway

  GamePublicSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref GamePublicSubnetA
      RouteTableId: !Ref GamePublicRouteTable

  GamePublicSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref GamePublicSubnetB
      RouteTableId: !Ref GamePublicRouteTable

# =====================
# NAT Gateway
# =====================
  GameNatEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: T3-Wagu-Game-NAT-EIP

  GameNatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt GameNatEIP.AllocationId
      SubnetId: !Ref GamePublicSubnetA
      Tags:
        - Key: Name
          Value: T3-Wagu-Game-NAT-GW

# =====================
# Private Route Table
# =====================
  GamePrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref GameVPC
      Tags:
        - Key: Name
          Value: T3-Wagu-Game-Private-RT

  GamePrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref GamePrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref GameNatGateway

  GamePrivateSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref GamePrivateSubnetA
      RouteTableId: !Ref GamePrivateRouteTable

  GamePrivateSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref GamePrivateSubnetB
      RouteTableId: !Ref GamePrivateRouteTable

# =====================
# VPC Peering
# =====================
  GameToMatchingPeering:
    Type: AWS::EC2::VPCPeeringConnection
    Properties:
      VpcId: !Ref GameVPC
      PeerVpcId: !ImportValue T3-Wagu-Matching-VPC-Id
      Tags:
        - Key: Name
          Value: T3-Wagu-Game-Matching-Peering

# =====================
# Routes to Matching VPC
# =====================
  GamePublicRouteToMatching:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref GamePublicRouteTable
      DestinationCidrBlock: !Ref MatchingVPCCidr
      VpcPeeringConnectionId: !Ref GameToMatchingPeering

  GamePrivateRouteToMatching:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref GamePrivateRouteTable
      DestinationCidrBlock: !Ref MatchingVPCCidr
      VpcPeeringConnectionId: !Ref GameToMatchingPeering

# =====================
# Outputs
# =====================
Outputs:
  GameVPCId:
    Value: !Ref GameVPC
    Export:
      Name: !Sub "${ProjectPrefix}-Game-VPC-Id"
