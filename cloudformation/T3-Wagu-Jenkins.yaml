AWSTemplateFormatVersion: "2010-09-09"
Description: Jenkins Server for WAGUWAGU (Matching/Game 분리)

Parameters:
  ProjectPrefix:
    Type: String
    Default: T3-Wagu

  InstanceType:
    Type: String
    Default: t3.medium
    AllowedValues:
      - t3.medium
      - t3.large
      - t3.xlarge

  LatestAmiId:
    Type: "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>"
    Default: "/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64"
    Description: Latest Amazon Linux 2023 AMI ID from SSM Parameter Store

  JenkinsAdminUser:
    Type: String
    Default: admin

  JenkinsAdminPassword:
    Type: String
    NoEcho: true

  # (선택) Jenkins URL 설정
  # 비워두면 Jenkins Location URL은 따로 설정하지 않음
  JenkinsBaseUrl:
    Type: String
    Default: ""
    Description: "Optional. Example: http://your-domain-or-ip:8080 (leave blank if not used)"

Resources:
  ############################################################
  # IAM Role for Jenkins EC2
  # -SSM 접속(세션 매니저)
  # -ECR push/pull
  # - (선택) EKS 접근/배포( CD 확장 시에)
  ############################################################
  JenkinsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectPrefix}-Jenkins-Role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/AmazonSSMFullAccess
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPowerUser
        - arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
        - arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
      Policies:
        - PolicyName: JenkinsECRPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                  - ecr:BatchCheckLayerAvailability
                  - ecr:GetDownloadUrlForLayer
                  - ecr:GetRepositoryPolicy
                  - ecr:DescribeRepositories
                  - ecr:ListImages
                  - ecr:DescribeImages
                  - ecr:BatchGetImage
                  - ecr:InitiateLayerUpload
                  - ecr:UploadLayerPart
                  - ecr:CompleteLayerUpload
                  - ecr:PutImage
                Resource: "*"

  JenkinsInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref JenkinsRole
      InstanceProfileName: !Sub "${ProjectPrefix}-Jenkins-Instance-Profile"

  ############################################################
  # Security Group (Matching Jenkins)
  # 지금은 Github Webhook 방식이 아니라, Poll SCM(내부에서 GitHub 확인) 방식을 사용하고 있어서
  # 8080 인바운드가 없어도 됨(SSM 포트포워딩으로 접속)
  # 나중에 GitHub Webhook을 나중에 쓴다고 하면 필요할 수는 있다 (GitHub IP 대역에서 8080 허용이 필요할 수 있음)
  ############################################################
  JenkinsMatchingSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security Group for Jenkins Matching Server (SSM + optional GitHub Webhook 8080)
      VpcId: !ImportValue T3-Wagu-Matching-VPC-Id

      SecurityGroupIngress:
        # (선택) GitHub Webhook -> Jenkins (HTTP 8080)
        # GitHub IP 대역은 변경될 수 있으므로 운영 시 최신 확인이 필요
        # 즉, 이 아래의 코드는 polling 방식이 아니라 webhook방식을 쓴다는 가정하에 존재하는 코드인거임
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 140.82.112.0/20

        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 192.30.252.0/22

      # 아웃바운드는 전체 허용(SSM, GitHub, ECR, EKS 등 접근 목적)
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

      Tags:
        - Key: Name
          Value: !Sub "${ProjectPrefix}-Jenkins-Matching-SG"
        - Key: Project
          Value: WAGUWAGU

  ############################################################
  # Security Group (Game Jenkins)
  # - 인바운드 완전 차단(SSM으로만 접속)
  # - Jenkins UI는 SSM 포트포워딩(localhost:8080)으로 접근
  # 이 아래에 있는 코드들도 polling방식이 아니라, webhook방식을 쓴다는 가정하게 존재하는 코드들
  ############################################################
  JenkinsGameSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security Group for Jenkins Game Server (SSM-only, no inbound)
      VpcId: !ImportValue T3-Wagu-Game-VPC-Id
      SecurityGroupIngress: []
      Tags:
        - Key: Name
          Value: !Sub "${ProjectPrefix}-Jenkins-Game-SG"
        - Key: Project
          Value: WAGUWAGU

  ############################################################
  # Jenkins EC2 Instance (Matching)
  # - matching-ci Job을 init.groovy로 자동 생성
  # - Poll SCM 트리거 적용, 5분마다
  ############################################################
  JenkinsInstanceMatching:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !Ref LatestAmiId
      IamInstanceProfile: !Ref JenkinsInstanceProfile

      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: "0"
          GroupSet:
            - !Ref JenkinsMatchingSG
          # Matching Public Subnet 중 첫 번째 사용
          SubnetId: !Select
            - 0
            - !Split
              - ","
              - !ImportValue T3-Wagu-Matching-Public-Subnet-Ids

      # Jenkins 자동 설치/설정(UserData)
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -euxo pipefail

          # 로그 남기기(실패 원인 확인용)
          exec > >(tee /var/log/user-data.log | logger -t user-data -s 2>/dev/console) 2>&1

          dnf update -y

          # CI에 필요한 도구들: docker/git/awscli (+ 편의 유틸)
          # NOTE: AL2023에서 curl 설치는 curl-minimal과 충돌 가능 -> 제외
          dnf install -y docker git wget unzip jq awscli
          systemctl enable --now docker

          # kubectl 설치 (KVER는 Fn::Sub 변수로 오해받지 않게 $KVER 사용)
          KVER="$(wget -qO- https://dl.k8s.io/release/stable.txt)"
          wget -q "https://dl.k8s.io/release/$KVER/bin/linux/amd64/kubectl" -O /usr/local/bin/kubectl
          chmod +x /usr/local/bin/kubectl

          # Jenkins 실행에 필요한 Java
          dnf install -y java-17-amazon-corretto

          # Jenkins repo (공식 방식)
          wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
          rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key

          dnf clean all
          dnf makecache -y
          dnf install -y jenkins

          # jenkins 유저가 docker 실행 가능하도록
          usermod -aG docker jenkins

          # 플러그인 자동 설치(Pipeline/Git/GitHub/Credentials 등)
          mkdir -p /var/lib/jenkins/plugins
          cat >/tmp/plugins.txt <<'EOF'
          workflow-aggregator
          git
          github
          github-branch-source
          credentials-binding
          pipeline-stage-view
          EOF

          export JENKINS_HOME=/var/lib/jenkins

          # jenkins-plugin-cli가 있으면 사용, 없으면 plugin manager tool(jar) 사용
          if command -v jenkins-plugin-cli >/dev/null 2>&1; then
            PLUGINS="$(tr '\n' ' ' </tmp/plugins.txt)"
            jenkins-plugin-cli --plugins "$PLUGINS" --plugin-dir /var/lib/jenkins/plugins
          else
            PIM_VER="2.13.2"
            wget -q -O /tmp/jenkins-plugin-manager.jar \
              "https://github.com/jenkinsci/plugin-installation-manager-tool/releases/download/$PIM_VER/jenkins-plugin-manager-$PIM_VER.jar"
            java -jar /tmp/jenkins-plugin-manager.jar \
              --war /usr/share/java/jenkins.war \
              --plugin-file /tmp/plugins.txt \
              --plugin-download-directory /var/lib/jenkins/plugins
          fi

          chown -R jenkins:jenkins /var/lib/jenkins

          # Setup Wizard 스킵 시도 (환경에 따라 완전히 안 먹을 수도 있음)
          mkdir -p /etc/sysconfig
          if [ -f /etc/sysconfig/jenkins ] && grep -q '^JENKINS_JAVA_OPTIONS=' /etc/sysconfig/jenkins; then
            sed -i 's#^JENKINS_JAVA_OPTIONS="\(.*\)"#JENKINS_JAVA_OPTIONS="\1 -Djenkins.install.runSetupWizard=false"#' /etc/sysconfig/jenkins
          else
            echo 'JENKINS_JAVA_OPTIONS="-Djenkins.install.runSetupWizard=false"' >> /etc/sysconfig/jenkins
          fi

          systemctl daemon-reload
          systemctl enable jenkins
          systemctl stop jenkins || true

          # 관리자 계정 자동 생성/보안 설정 + (선택) Jenkins URL 설정
          mkdir -p /var/lib/jenkins/init.groovy.d
          cat >/var/lib/jenkins/init.groovy.d/01-security.groovy <<'GROOVY'
          import jenkins.model.*
          import hudson.security.*
          import jenkins.model.JenkinsLocationConfiguration

          def instance = Jenkins.get()

          def adminUser = "${JenkinsAdminUser}"
          def adminPass = "${JenkinsAdminPassword}"

          def realm = new HudsonPrivateSecurityRealm(false)
          if (realm.getUser(adminUser) == null) {
            realm.createAccount(adminUser, adminPass)
          }
          instance.setSecurityRealm(realm)

          def strategy = new FullControlOnceLoggedInAuthorizationStrategy()
          strategy.setAllowAnonymousRead(false)
          instance.setAuthorizationStrategy(strategy)

          def baseUrl = "${JenkinsBaseUrl}"
          if (baseUrl != null && baseUrl.trim().length() > 0) {
            def loc = JenkinsLocationConfiguration.get()
            loc.setUrl(baseUrl.trim())
            loc.save()
          }

          instance.save()
          GROOVY

          # Job 자동 생성 (matching-ci) + Poll SCM
          cat >/var/lib/jenkins/init.groovy.d/02-jobs.groovy <<'GROOVY'
          import jenkins.model.*
          import org.jenkinsci.plugins.workflow.job.WorkflowJob
          import org.jenkinsci.plugins.workflow.cps.CpsScmFlowDefinition
          import hudson.plugins.git.*
          import hudson.triggers.SCMTrigger

          def j = Jenkins.get()

          def repoUrl = "https://github.com/ms-waguwagu/waguwagu-server.git"
          def branchSpec = "*/main"

          def ensurePipelineJob = { String jobName, String scriptPath ->
            def existing = j.getItem(jobName)
            if (existing != null) {
              println("[OK] Job already exists: " + jobName)
              return
            }

            println("[CREATE] Job: " + jobName)

            WorkflowJob job = j.createProject(WorkflowJob, jobName)

            def remote = new UserRemoteConfig(repoUrl, null, null, null) // public repo -> credentialsId 불필요
            def scm = new GitSCM(
              [remote],
              [new BranchSpec(branchSpec)],
              false,
              [],
              null,
              null,
              []
            )

            job.definition = new CpsScmFlowDefinition(scm, scriptPath)

            // Poll SCM: 5분마다 변경 감지
            job.addTrigger(new SCMTrigger("H/2 * * * *"))

            job.save()
          }

          ensurePipelineJob("matching-ci", "matching-server/Jenkinsfile")
          j.save()
          GROOVY

          chown -R jenkins:jenkins /var/lib/jenkins/init.groovy.d

          systemctl start jenkins
          systemctl status jenkins --no-pager || true
          ss -lntp | grep 8080 || true
          wget -qS --spider http://localhost:8080/login || true

      Tags:
        - Key: Name
          Value: !Sub "${ProjectPrefix}-Jenkins-Matching"
        - Key: Project
          Value: WAGUWAGU

  ############################################################
  # Jenkins EC2 Instance (Game)
  # - game-ci Job을 init.groovy로 자동 생성
  # - Poll 트리거 적용, 5분마다
  ############################################################
  JenkinsInstanceGame:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !Ref LatestAmiId
      IamInstanceProfile: !Ref JenkinsInstanceProfile

      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: "0"
          GroupSet:
            - !Ref JenkinsGameSG
          # Game Public Subnet 중 첫 번째 사용
          SubnetId: !Select
            - 0
            - !Split
              - ","
              - !ImportValue T3-Wagu-Game-Public-Subnet-Ids

      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -euxo pipefail

          # 로그 남기기(실패 원인 확인용)
          exec > >(tee /var/log/user-data.log | logger -t user-data -s 2>/dev/console) 2>&1

          dnf update -y

          # CI에 필요한 도구들: docker/git/awscli (+ 편의 유틸)
          dnf install -y docker git wget unzip jq awscli
          systemctl enable --now docker

          # kubectl 설치
          KVER="$(wget -qO- https://dl.k8s.io/release/stable.txt)"
          wget -q "https://dl.k8s.io/release/$KVER/bin/linux/amd64/kubectl" -O /usr/local/bin/kubectl
          chmod +x /usr/local/bin/kubectl

          dnf install -y java-17-amazon-corretto

          # Jenkins repo (공식 방식)
          wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
          rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key

          dnf clean all
          dnf makecache -y
          dnf install -y jenkins

          # jenkins 유저가 docker 실행 가능하도록
          usermod -aG docker jenkins

          # 플러그인 자동 설치
          mkdir -p /var/lib/jenkins/plugins
          cat >/tmp/plugins.txt <<'EOF'
          workflow-aggregator
          git
          github
          github-branch-source
          credentials-binding
          pipeline-stage-view
          EOF

          export JENKINS_HOME=/var/lib/jenkins

          if command -v jenkins-plugin-cli >/dev/null 2>&1; then
            PLUGINS="$(tr '\n' ' ' </tmp/plugins.txt)"
            jenkins-plugin-cli --plugins "$PLUGINS" --plugin-dir /var/lib/jenkins/plugins
          else
            PIM_VER="2.13.2"
            wget -q -O /tmp/jenkins-plugin-manager.jar \
              "https://github.com/jenkinsci/plugin-installation-manager-tool/releases/download/$PIM_VER/jenkins-plugin-manager-$PIM_VER.jar"
            java -jar /tmp/jenkins-plugin-manager.jar \
              --war /usr/share/java/jenkins.war \
              --plugin-file /tmp/plugins.txt \
              --plugin-download-directory /var/lib/jenkins/plugins
          fi

          chown -R jenkins:jenkins /var/lib/jenkins

          # Setup Wizard 스킵 시도
          mkdir -p /etc/sysconfig
          if [ -f /etc/sysconfig/jenkins ] && grep -q '^JENKINS_JAVA_OPTIONS=' /etc/sysconfig/jenkins; then
            sed -i 's#^JENKINS_JAVA_OPTIONS="\(.*\)"#JENKINS_JAVA_OPTIONS="\1 -Djenkins.install.runSetupWizard=false"#' /etc/sysconfig/jenkins
          else
            echo 'JENKINS_JAVA_OPTIONS="-Djenkins.install.runSetupWizard=false"' >> /etc/sysconfig/jenkins
          fi

          systemctl daemon-reload
          systemctl enable jenkins
          systemctl stop jenkins || true

          # 관리자 계정 자동 생성/보안 설정
          mkdir -p /var/lib/jenkins/init.groovy.d
          cat >/var/lib/jenkins/init.groovy.d/01-security.groovy <<'GROOVY'
          import jenkins.model.*
          import hudson.security.*
          import jenkins.model.JenkinsLocationConfiguration

          def instance = Jenkins.get()

          def adminUser = "${JenkinsAdminUser}"
          def adminPass = "${JenkinsAdminPassword}"

          def realm = new HudsonPrivateSecurityRealm(false)
          if (realm.getUser(adminUser) == null) {
            realm.createAccount(adminUser, adminPass)
          }
          instance.setSecurityRealm(realm)

          def strategy = new FullControlOnceLoggedInAuthorizationStrategy()
          strategy.setAllowAnonymousRead(false)
          instance.setAuthorizationStrategy(strategy)

          def baseUrl = "${JenkinsBaseUrl}"
          if (baseUrl != null && baseUrl.trim().length() > 0) {
            def loc = JenkinsLocationConfiguration.get()
            loc.setUrl(baseUrl.trim())
            loc.save()
          }

          instance.save()
          GROOVY

          # Job 자동 생성 (game-ci) + Poll SCM
          cat >/var/lib/jenkins/init.groovy.d/02-jobs.groovy <<'GROOVY'
          import jenkins.model.*
          import org.jenkinsci.plugins.workflow.job.WorkflowJob
          import org.jenkinsci.plugins.workflow.cps.CpsScmFlowDefinition
          import hudson.plugins.git.*
          import hudson.triggers.SCMTrigger

          def j = Jenkins.get()

          def repoUrl = "https://github.com/ms-waguwagu/waguwagu-server.git"
          def branchSpec = "*/main"

          def ensurePipelineJob = { String jobName, String scriptPath ->
            def existing = j.getItem(jobName)
            if (existing != null) {
              println("[OK] Job already exists: " + jobName)
              return
            }

            println("[CREATE] Job: " + jobName)

            WorkflowJob job = j.createProject(WorkflowJob, jobName)

            def remote = new UserRemoteConfig(repoUrl, null, null, null) // public repo -> credentialsId 불필요
            def scm = new GitSCM(
              [remote],
              [new BranchSpec(branchSpec)],
              false,
              [],
              null,
              null,
              []
            )

            job.definition = new CpsScmFlowDefinition(scm, scriptPath)

            // Poll SCM: 5분마다 변경 감지
            job.addTrigger(new SCMTrigger("H/2 * * * *"))

            job.save()
          }

          ensurePipelineJob("game-ci", "game-server/Jenkinsfile")
          j.save()
          GROOVY

          chown -R jenkins:jenkins /var/lib/jenkins/init.groovy.d

          systemctl start jenkins
          systemctl status jenkins --no-pager || true
          ss -lntp | grep 8080 || true
          wget -qS --spider http://localhost:8080/login || true

      Tags:
        - Key: Name
          Value: !Sub "${ProjectPrefix}-Jenkins-Game"
        - Key: Project
          Value: WAGUWAGU

Outputs:
  JenkinsInstanceMatchingId:
    Value: !Ref JenkinsInstanceMatching
    Description: Instance ID of the Jenkins Matching Server
    Export:
      Name: !Sub "${ProjectPrefix}-Jenkins-Matching-Instance-Id"

  JenkinsInstanceMatchingPublicIp:
    Value: !GetAtt JenkinsInstanceMatching.PublicIp
    Description: Public IP of the Jenkins Matching Server

  JenkinsInstanceGameId:
    Value: !Ref JenkinsInstanceGame
    Description: Instance ID of the Jenkins Game Server
    Export:
      Name: !Sub "${ProjectPrefix}-Jenkins-Game-Instance-Id"

  JenkinsInstanceGamePublicIp:
    Value: !GetAtt JenkinsInstanceGame.PublicIp
    Description: Public IP of the Jenkins Game Server
