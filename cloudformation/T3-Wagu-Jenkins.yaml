AWSTemplateFormatVersion: "2010-09-09"
Description: Jenkins Server for WAGUWAGU (Matching/Game Î∂ÑÎ¶¨)

Parameters:
  ProjectPrefix:
    Type: String
    Default: T3-Wagu

  InstanceType:
    Type: String
    Default: t3.medium
    AllowedValues:
      - t3.medium
      - t3.large
      - t3.xlarge

  LatestAmiId:
    Type: "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>"
    Default: "/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64"
    Description: Latest Amazon Linux 2023 AMI ID from SSM Parameter Store

  JenkinsAdminUser:
    Type: String
    Default: admin

  JenkinsAdminPassword:
    Type: String
    NoEcho: true

  # (?Ñ†?Éù) Jenkins URL ?Ñ§?†ï
  # ÎπÑÏõå?ëêÎ©? Jenkins Location URL??? ?î∞Î°? ?Ñ§?†ï?ïòÏß? ?ïä?ùå
  JenkinsBaseUrl:
    Type: String
    Default: ""
    Description: "Optional. Example: http://your-domain-or-ip:8080 (leave blank if not used)"

  #  Frontend S3 ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ ÔøΩÔøΩ≈∂ÔøΩÔøΩ (IAM ÔøΩÔøΩ√•ÔøΩÔøΩÔøΩÔøΩ ÔøΩÔøΩÔø?)
  #  frontend/JenkinsfileÔøΩÔøΩ S3_BUCKET ÔøΩÔøΩÔøΩÔøΩ ÔøΩÔøΩÔøΩÔøΩÔøΩÿæÔøΩ ÔøΩÔøΩ
  FrontendBucketName:
    Type: String
    Default: waguwagu-s3-bucket-061039804626-ap-northeast-2
    #Default: waguwagu-s3-bucket-269397878198-ap-northeast-2 ≥ª ∞Ë¡§ ¡÷ºÆ

  ############################################################
  # CloudFront Distribution IDÔøΩÔøΩ ÔøΩÔøΩÔøΩÔøΩÔøΩÿµÔøΩ Secrets Manager Secret ÔøΩÔøΩÔøΩÔøΩ
  # - JenkinsfileÔøΩÔøΩÔøΩÔøΩ aws secretsmanager get-secret-value ÔøΩÔøΩ ÔøΩÔøΩÔøΩÔøΩ ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ
  # - SecretString(JSON) ÔøΩ»øÔøΩ ÔøΩ∆∑ÔøΩ KeyÔøΩÔøΩ Distribution IDÔøΩÔøΩ ÔøΩ÷æÔøΩÔøΩ÷∏ÔøΩ ÔøΩÔøΩ
  ############################################################
  CloudFrontSecretName:
    Type: String
    Default: "T3-Wagu-Secrets"
    Description: "Secrets Manager secret name that contains CloudFront Distribution ID"

  CloudFrontSecretKey:
    Type: String
    Default: "CLOUDFRONT_DISTRIBUTION_ID"
    Description: "Key inside SecretString JSON for CloudFront Distribution ID"

  ############################################################
  # GitHub PAT (Secrets Manager) - Jenkins∞° waguwagu-infraø° push«“ ∂ß ªÁøÎ
  # - SecretString(JSON) æ»ø° Key∑Œ GITHUB_PAT ∏¶ ≥÷¥¬ ¿¸¡¶
  # - ±‚¡∏ Secret(T3-Wagu-Secrets) ¿ÁªÁøÎ
  ############################################################
  GitHubPatSecretName:
    Type: String
    Default: "T3-Wagu-Secrets"

  GitHubPatSecretKey:
    Type: String
    Default: "GITHUB_PAT"

Resources:
  ############################################################
  # IAM Role for Jenkins EC2
  # -SSM ?†ë?Üç(?Ñ∏?Öò Îß§Îãà???)
  # -ECR push/pull
  # - (?Ñ†?Éù) EKS ?†ëÍ∑?/Î∞∞Ìè¨( CD ?ôï?û• ?ãú?óê)
  ############################################################
  JenkinsRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ProjectPrefix}-Jenkins-Role"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/AmazonSSMFullAccess
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPowerUser
        - arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
        - arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
      Policies:
        - PolicyName: JenkinsECRPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                  - ecr:BatchCheckLayerAvailability
                  - ecr:GetDownloadUrlForLayer
                  - ecr:GetRepositoryPolicy
                  - ecr:DescribeRepositories
                  - ecr:ListImages
                  - ecr:DescribeImages
                  - ecr:BatchGetImage
                  - ecr:InitiateLayerUpload
                  - ecr:UploadLayerPart
                  - ecr:CompleteLayerUpload
                  - ecr:PutImage
                Resource: "*"

        # Frontend ÔøΩÔøΩÔøΩÔøΩ(S3 sync) ÔøΩÔøΩÔøΩÔøΩ ÔøΩﬂ∞ÔøΩ
        - PolicyName: JenkinsFrontendS3Policy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:GetBucketLocation
                Resource: !Sub "arn:aws:s3:::${FrontendBucketName}"

              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub "arn:aws:s3:::${FrontendBucketName}/*"

        ############################################################
        #  CloudFront ƒ≥ÔøΩÔøΩ ÔøΩÔøΩ»ø»≠(Invalidation) + Secrets ManagerÔøΩÔøΩÔøΩÔøΩ Distribution ID ÔøΩ–±ÔøΩ
        # - JenkinsfileÔøΩÔøΩÔøΩÔøΩ aws secretsmanager get-secret-value ÔøΩÔøΩ ÔøΩÔøΩÔøΩÔøΩ ÔøΩ–∞ÔøΩ
        # - aws cloudfront create-invalidation ÔøΩÔøΩÔøΩÔøΩ ÔøΩÔøΩ»ø»≠ ÔøΩÔøΩÔøΩÔøΩ
        ############################################################
        - PolicyName: JenkinsCloudFrontInvalidationPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              # Secrets Manager ÔøΩ–±ÔøΩ ÔøΩÔøΩÔøΩÔøΩ
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                # Secret ARNÔøΩÔøΩ ÔøΩ⁄øÔøΩ ÔøΩÔøΩÔøΩÔøΩ suffixÔøΩÔøΩ ÔøΩŸæÓº≠ * √≥ÔøΩÔøΩ ÔøΩ øÔøΩ
                Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${CloudFrontSecretName}-*"

              # (√ﬂ∞°) GitHub PAT Secretµµ ¿–±‚ «„øÎ (±‚∫ª∞™¿Ã CloudFrontSecretName∞˙ ∞∞æ∆µµ æ»¿¸)
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${GitHubPatSecretName}-*"

              # CloudFront ÔøΩÔøΩ»ø»≠ ÔøΩÔøΩÔøΩÔøΩ
              # CloudFrontÔøΩÔøΩ ÔøΩÔøΩÔøΩ“ΩÔøΩ ÔøΩÔøΩÔøΩÔøΩ ARN ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ ÔøΩÔøΩÔøΩ≈∑ŒøÔøΩ ÔøΩ«πÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ Resource:"*"ÔøΩÔøΩ ÔøΩŒ¥ÔøΩ ÔøΩÔøΩÔø? ÔøΩÔøΩÔøΩÔøΩ
              - Effect: Allow
                Action:
                  - cloudfront:CreateInvalidation
                  - cloudfront:GetDistribution
                Resource: "*"

  JenkinsInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref JenkinsRole
      InstanceProfileName: !Sub "${ProjectPrefix}-Jenkins-Instance-Profile"

  ############################################################
  # Security Group (Matching Jenkins)
  # Ïß?Í∏àÏ?? Github Webhook Î∞©Ïãù?ù¥ ?ïÑ?ãà?ùº, Poll SCM(?Ç¥Î∂??óê?Ñú GitHub ?ôï?ù∏) Î∞©Ïãù?ùÑ ?Ç¨?ö©?ïòÍ≥? ?ûà?ñ¥?Ñú
  # 8080 ?ù∏Î∞îÏö¥?ìúÍ∞? ?óÜ?ñ¥?èÑ ?ê®(SSM ?è¨?ä∏?è¨?õå?î©?úºÎ°? ?†ë?Üç)
  # ?ÇòÏ§ëÏóê GitHub Webhook?ùÑ ?ÇòÏ§ëÏóê ?ì¥?ã§Í≥? ?ïòÎ©? ?ïÑ?öî?ï† ?àò?äî ?ûà?ã§ (GitHub IP ????ó≠?óê?Ñú 8080 ?óà?ö©?ù¥ ?ïÑ?öî?ï† ?àò ?ûà?ùå)
  ############################################################
  JenkinsMatchingSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security Group for Jenkins Matching Server (SSM + optional GitHub Webhook 8080)
      VpcId: !ImportValue T3-Wagu-Matching-VPC-Id

      SecurityGroupIngress:
        # (?Ñ†?Éù) GitHub Webhook -> Jenkins (HTTP 8080)
        # GitHub IP ????ó≠??? Î≥?Í≤ΩÎê† ?àò ?ûà?úºÎØ?Î°? ?ö¥?òÅ ?ãú ÏµúÏã† ?ôï?ù∏?ù¥ ?ïÑ?öî
        # Ï¶?, ?ù¥ ?ïÑ?ûò?ùò ÏΩîÎìú?äî polling Î∞©Ïãù?ù¥ ?ïÑ?ãà?ùº webhookÎ∞©Ïãù?ùÑ ?ì¥?ã§?äî Í∞??†ï?ïò?óê Ï°¥Ïû¨?ïò?äî ÏΩîÎìú?ù∏Í±∞ÏûÑ
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 140.82.112.0/20

        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 192.30.252.0/22

      # ?ïÑ?õÉÎ∞îÏö¥?ìú?äî ?†ÑÏ≤? ?óà?ö©(SSM, GitHub, ECR, EKS ?ì± ?†ëÍ∑? Î™©Ï†Å)
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

      Tags:
        - Key: Name
          Value: !Sub "${ProjectPrefix}-Jenkins-Matching-SG"
        - Key: Project
          Value: WAGUWAGU

  ############################################################
  # Security Group (Game Jenkins)
  # - ?ù∏Î∞îÏö¥?ìú ?ôÑ?†Ñ Ï∞®Îã®(SSM?úºÎ°úÎßå ?†ë?Üç)
  # - Jenkins UI?äî SSM ?è¨?ä∏?è¨?õå?î©(localhost:8080)?úºÎ°? ?†ëÍ∑?
  # ?ù¥ ?ïÑ?ûò?óê ?ûà?äî ÏΩîÎìú?ì§?èÑ pollingÎ∞©Ïãù?ù¥ ?ïÑ?ãà?ùº, webhookÎ∞©Ïãù?ùÑ ?ì¥?ã§?äî Í∞??†ï?ïòÍ≤? Ï°¥Ïû¨?ïò?äî ÏΩîÎìú?ì§
  ############################################################
  JenkinsGameSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security Group for Jenkins Game Server (SSM-only, no inbound)
      VpcId: !ImportValue T3-Wagu-Game-VPC-Id
      SecurityGroupIngress: []

      # (ÔøΩÔøΩÔøΩÔøΩ ÔøΩÔøΩÔøΩÔøΩ) ÔøΩ∆øÔøΩÔøΩŸøÔøΩÔø? ÔøΩÔøΩ√º ÔøΩÔøΩÔø? (SSM/GitHub/ECR/S3/CloudFront ÔøΩÔøΩÔøΩÔøΩ ÔøΩÔøΩÔøΩÔøΩ)
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

      Tags:
        - Key: Name
          Value: !Sub "${ProjectPrefix}-Jenkins-Game-SG"
        - Key: Project
          Value: WAGUWAGU

  ############################################################
  # Jenkins EC2 Instance (Matching)
  # - matching-ci Job?ùÑ init.groovyÎ°? ?ûê?èô ?Éù?Ñ±
  # - Poll SCM ?ä∏Î¶¨Í±∞ ?†Å?ö©, 5Î∂ÑÎßà?ã§
  ############################################################
  JenkinsInstanceMatching:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !Ref LatestAmiId
      IamInstanceProfile: !Ref JenkinsInstanceProfile

      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: "0"
          GroupSet:
            - !Ref JenkinsMatchingSG
          # Matching Public Subnet Ï§? Ï≤? Î≤àÏß∏ ?Ç¨?ö©
          SubnetId: !Select
            - 0
            - !Split
              - ","
              - !ImportValue T3-Wagu-Matching-Public-Subnet-Ids

      # Jenkins ?ûê?èô ?Ñ§Ïπ?/?Ñ§?†ï(UserData)
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -euxo pipefail

          # Î°úÍ∑∏ ?Ç®Í∏∞Í∏∞(?ã§?å® ?õê?ù∏ ?ôï?ù∏?ö©)
          exec > >(tee /var/log/user-data.log | logger -t user-data -s 2>/dev/console) 2>&1

          dnf update -y

          # CI?óê ?ïÑ?öî?ïú ?èÑÍµ¨Îì§: docker/git/awscli (+ ?é∏?ùò ?ú†?ã∏)
          # NOTE: AL2023?óê?Ñú curl ?Ñ§ÏπòÎäî curl-minimalÍ≥? Ï∂©Îèå Í∞??ä• -> ?†ú?ô∏
          dnf install -y docker git wget unzip jq awscli
          systemctl enable --now docker

          # kubectl ?Ñ§Ïπ? (KVER?äî Fn::Sub Î≥??àòÎ°? ?ò§?ï¥Î∞õÏ?? ?ïäÍ≤? $KVER ?Ç¨?ö©)
          KVER="$(wget -qO- https://dl.k8s.io/release/stable.txt)"
          wget -q "https://dl.k8s.io/release/$KVER/bin/linux/amd64/kubectl" -O /usr/local/bin/kubectl
          chmod +x /usr/local/bin/kubectl

          # Jenkins ?ã§?ñâ?óê ?ïÑ?öî?ïú Java
          dnf install -y java-17-amazon-corretto

          # Jenkins repo (Í≥µÏãù Î∞©Ïãù)
          wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
          rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key

          dnf clean all
          dnf makecache -y
          dnf install -y jenkins

          # jenkins ?ú†???Í∞? docker ?ã§?ñâ Í∞??ä•?ïò?èÑÎ°?
          usermod -aG docker jenkins

          # ?îå?ü¨Í∑∏Ïù∏ ?ûê?èô ?Ñ§Ïπ?(Pipeline/Git/GitHub/Credentials ?ì±)
          mkdir -p /var/lib/jenkins/plugins
          cat >/tmp/plugins.txt <<'EOF'
          workflow-aggregator
          git
          github
          github-branch-source
          credentials-binding
          plain-credentials
          pipeline-stage-view
          EOF

          export JENKINS_HOME=/var/lib/jenkins

          # jenkins-plugin-cliÍ∞? ?ûà?úºÎ©? ?Ç¨?ö©, ?óÜ?úºÎ©? plugin manager tool(jar) ?Ç¨?ö©
          if command -v jenkins-plugin-cli >/dev/null 2>&1; then
            PLUGINS="$(tr '\n' ' ' </tmp/plugins.txt)"
            jenkins-plugin-cli --plugins "$PLUGINS" --plugin-dir /var/lib/jenkins/plugins
          else
            PIM_VER="2.13.2"
            wget -q -O /tmp/jenkins-plugin-manager.jar \
              "https://github.com/jenkinsci/plugin-installation-manager-tool/releases/download/$PIM_VER/jenkins-plugin-manager-$PIM_VER.jar"
            java -jar /tmp/jenkins-plugin-manager.jar \
              --war /usr/share/java/jenkins.war \
              --plugin-file /tmp/plugins.txt \
              --plugin-download-directory /var/lib/jenkins/plugins
          fi

          chown -R jenkins:jenkins /var/lib/jenkins

          # Setup Wizard ?ä§?Çµ ?ãú?èÑ (?ôòÍ≤ΩÏóê ?î∞?ùº ?ôÑ?†Ñ?ûà ?ïà Î®πÏùÑ ?àò?èÑ ?ûà?ùå)
          mkdir -p /etc/sysconfig
          if [ -f /etc/sysconfig/jenkins ] && grep -q '^JENKINS_JAVA_OPTIONS=' /etc/sysconfig/jenkins; then
            sed -i 's#^JENKINS_JAVA_OPTIONS="\\(.*\\)"#JENKINS_JAVA_OPTIONS="\\1 -Djenkins.install.runSetupWizard=false"#' /etc/sysconfig/jenkins
          else
            echo 'JENKINS_JAVA_OPTIONS="-Djenkins.install.runSetupWizard=false"' >> /etc/sysconfig/jenkins
          fi

          systemctl daemon-reload
          systemctl enable jenkins
          systemctl stop jenkins || true

          # GitHub PAT∏¶ Secrets Managerø°º≠ ¿–æÓº≠ ∆ƒ¿œ∑Œ ¿˙¿Â (∑Œ±◊ ≥Î√‚ πÊ¡ˆ)
          set +x
          PAT="$(aws secretsmanager get-secret-value \
            --secret-id ${GitHubPatSecretName} \
            --query SecretString \
            --output text \
            --region ${AWS::Region} | jq -r '.${GitHubPatSecretKey}')"

          # ? (∆–ƒ°) µ∑∫≈‰∏Æ∏¶ jenkins º“¿Ø/±««—¿∏∑Œ "√≥¿Ω∫Œ≈Õ" ª˝º∫ (¿Á∫Œ∆√/¿Áª˝º∫ø°µµ øµ±∏¿˚¿∏∑Œ µø¿œ)
          install -d -o jenkins -g jenkins -m 700 /var/lib/jenkins/secret-files
          printf '%s' "$PAT" > /var/lib/jenkins/secret-files/github_pat
          chown jenkins:jenkins /var/lib/jenkins/secret-files/github_pat
          chmod 600 /var/lib/jenkins/secret-files/github_pat

          unset PAT
          set -x

          # Í¥?Î¶¨Ïûê Í≥ÑÏ†ï ?ûê?èô ?Éù?Ñ±/Î≥¥Ïïà ?Ñ§?†ï + (?Ñ†?Éù) Jenkins URL ?Ñ§?†ï
          mkdir -p /var/lib/jenkins/init.groovy.d
          cat >/var/lib/jenkins/init.groovy.d/01-security.groovy <<'GROOVY'
          import jenkins.model.*
          import hudson.security.*
          import jenkins.model.JenkinsLocationConfiguration

          def instance = Jenkins.get()

          def adminUser = "${JenkinsAdminUser}"
          def adminPass = "${JenkinsAdminPassword}"

          def realm = new HudsonPrivateSecurityRealm(false)
          if (realm.getUser(adminUser) == null) {
            realm.createAccount(adminUser, adminPass)
          }
          instance.setSecurityRealm(realm)

          def strategy = new FullControlOnceLoggedInAuthorizationStrategy()
          strategy.setAllowAnonymousRead(false)
          instance.setAuthorizationStrategy(strategy)

          def baseUrl = "${JenkinsBaseUrl}"
          if (baseUrl != null && baseUrl.trim().length() > 0) {
            def loc = JenkinsLocationConfiguration.get()
            loc.setUrl(baseUrl.trim())
            loc.save()
          }

          instance.save()
          GROOVY

          # Jenkins Credentials ¿⁄µø ª˝º∫ (Secret Text) - ID: github-pat-infra-push
          cat >/var/lib/jenkins/init.groovy.d/03-credentials.groovy <<'GROOVY'
          import jenkins.model.*
          import com.cloudbees.plugins.credentials.*
          import com.cloudbees.plugins.credentials.domains.*
          import com.cloudbees.plugins.credentials.common.StandardCredentials
          import org.jenkinsci.plugins.plaincredentials.impl.StringCredentialsImpl
          import hudson.util.Secret

          def id = "github-pat-infra-push"
          def desc = "GitHub PAT for pushing waguwagu-infra manifests"
          def f = new File("/var/lib/jenkins/secret-files/github_pat")

          if (!f.exists()) {
            println("[WARN] github_pat file not found. Skip creating credential.")
            return
          }

          def pat = f.text.trim()
          if (pat == null || pat.length() == 0) {
            println("[WARN] github_pat is empty. Skip creating credential.")
            return
          }

          def j = Jenkins.get()
          def provider = j.getExtensionList('com.cloudbees.plugins.credentials.SystemCredentialsProvider')[0]
          def store = provider.getStore()
          def domain = Domain.global()

          def existing = com.cloudbees.plugins.credentials.CredentialsProvider.lookupCredentials(
            StandardCredentials.class, j, null, null
          ).find { it.id == id }

          if (existing != null) {
            store.removeCredentials(domain, existing)
          }

          def c = new StringCredentialsImpl(CredentialsScope.GLOBAL, id, desc, Secret.fromString(pat))
          store.addCredentials(domain, c)
          println("[OK] Created/Updated credential: " + id)
          GROOVY

          # Job ?ûê?èô ?Éù?Ñ± (matching-ci) + Poll SCM
          cat >/var/lib/jenkins/init.groovy.d/02-jobs.groovy <<'GROOVY'
          import jenkins.model.*
          import org.jenkinsci.plugins.workflow.job.WorkflowJob
          import org.jenkinsci.plugins.workflow.cps.CpsScmFlowDefinition
          import hudson.plugins.git.*
          import hudson.triggers.SCMTrigger

          def j = Jenkins.get()

          def repoUrl = "https://github.com/ms-waguwagu/waguwagu-server.git"
          def branchSpec = "*/main"

          def ensurePipelineJob = { String jobName, String scriptPath ->
            def existing = j.getItem(jobName)
            if (existing != null) {
              println("[OK] Job already exists: " + jobName)
              return
            }

            println("[CREATE] Job: " + jobName)

            WorkflowJob job = j.createProject(WorkflowJob, jobName)

            def remote = new UserRemoteConfig(repoUrl, null, null, null) // public repo -> credentialsId Î∂àÌïÑ?öî
            def scm = new GitSCM(
              [remote],
              [new BranchSpec(branchSpec)],
              false,
              [],
              null,
              null,
              []
            )

            job.definition = new CpsScmFlowDefinition(scm, scriptPath)

            // Poll SCM: 5Î∂ÑÎßà?ã§ Î≥?Í≤? Í∞êÏ??
            job.addTrigger(new SCMTrigger("H/2 * * * *"))

            job.save()
          }

          ensurePipelineJob("matching-ci", "matching-server/Jenkinsfile")
          ensurePipelineJob("frontend-ci", "frontend/Jenkinsfile")
          j.save()
          GROOVY

          chown -R jenkins:jenkins /var/lib/jenkins/init.groovy.d

          systemctl start jenkins
          systemctl status jenkins --no-pager || true
          ss -lntp | grep 8080 || true
          wget -qS --spider http://localhost:8080/login || true

      Tags:
        - Key: Name
          Value: !Sub "${ProjectPrefix}-Jenkins-Matching"
        - Key: Project
          Value: WAGUWAGU

  ############################################################
  # Jenkins EC2 Instance (Game)
  # - game-ci Job?ùÑ init.groovyÎ°? ?ûê?èô ?Éù?Ñ±
  # - Poll ?ä∏Î¶¨Í±∞ ?†Å?ö©, 5Î∂ÑÎßà?ã§
  ############################################################
  JenkinsInstanceGame:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !Ref LatestAmiId
      IamInstanceProfile: !Ref JenkinsInstanceProfile

      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: "0"
          GroupSet:
            - !Ref JenkinsGameSG
          # Game Public Subnet Ï§? Ï≤? Î≤àÏß∏ ?Ç¨?ö©
          SubnetId: !Select
            - 0
            - !Split
              - ","
              - !ImportValue T3-Wagu-Game-Public-Subnet-Ids

      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -euxo pipefail

          # Î°úÍ∑∏ ?Ç®Í∏∞Í∏∞(?ã§?å® ?õê?ù∏ ?ôï?ù∏?ö©)
          exec > >(tee /var/log/user-data.log | logger -t user-data -s 2>/dev/console) 2>&1

          dnf update -y

          # CI?óê ?ïÑ?öî?ïú ?èÑÍµ¨Îì§: docker/git/awscli (+ ?é∏?ùò ?ú†?ã∏)
          dnf install -y docker git wget unzip jq awscli
          systemctl enable --now docker

          # kubectl ?Ñ§Ïπ?
          KVER="$(wget -qO- https://dl.k8s.io/release/stable.txt)"
          wget -q "https://dl.k8s.io/release/$KVER/bin/linux/amd64/kubectl" -O /usr/local/bin/kubectl
          chmod +x /usr/local/bin/kubectl

          dnf install -y java-17-amazon-corretto

          # Jenkins repo (Í≥µÏãù Î∞©Ïãù)
          wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo
          rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key

          dnf clean all
          dnf makecache -y
          dnf install -y jenkins

          # jenkins ?ú†???Í∞? docker ?ã§?ñâ Í∞??ä•?ïò?èÑÎ°?
          usermod -aG docker jenkins

          # ?îå?ü¨Í∑∏Ïù∏ ?ûê?èô ?Ñ§Ïπ?
          mkdir -p /var/lib/jenkins/plugins
          cat >/tmp/plugins.txt <<'EOF'
          workflow-aggregator
          git
          github
          github-branch-source
          credentials-binding
          plain-credentials
          pipeline-stage-view
          EOF

          export JENKINS_HOME=/var/lib/jenkins

          if command -v jenkins-plugin-cli >/dev/null 2>&1; then
            PLUGINS="$(tr '\n' ' ' </tmp/plugins.txt)"
            jenkins-plugin-cli --plugins "$PLUGINS" --plugin-dir /var/lib/jenkins/plugins
          else
            PIM_VER="2.13.2"
            wget -q -O /tmp/jenkins-plugin-manager.jar \
              "https://github.com/jenkinsci/plugin-installation-manager-tool/releases/download/$PIM_VER/jenkins-plugin-manager-$PIM_VER.jar"
            java -jar /tmp/jenkins-plugin-manager.jar \
              --war /usr/share/java/jenkins.war \
              --plugin-file /tmp/plugins.txt \
              --plugin-download-directory /var/lib/jenkins/plugins
          fi

          chown -R jenkins:jenkins /var/lib/jenkins

          # Setup Wizard ?ä§?Çµ ?ãú?èÑ
          mkdir -p /etc/sysconfig
          if [ -f /etc/sysconfig/jenkins ] && grep -q '^JENKINS_JAVA_OPTIONS=' /etc/sysconfig/jenkins; then
            sed -i 's#^JENKINS_JAVA_OPTIONS="\\(.*\\)"#JENKINS_JAVA_OPTIONS="\\1 -Djenkins.install.runSetupWizard=false"#' /etc/sysconfig/jenkins
          else
            echo 'JENKINS_JAVA_OPTIONS="-Djenkins.install.runSetupWizard=false"' >> /etc/sysconfig/jenkins
          fi

          systemctl daemon-reload
          systemctl enable jenkins
          systemctl stop jenkins || true

          # GitHub PAT∏¶ Secrets Managerø°º≠ ¿–æÓº≠ ∆ƒ¿œ∑Œ ¿˙¿Â (∑Œ±◊ ≥Î√‚ πÊ¡ˆ)
          set +x
          PAT="$(aws secretsmanager get-secret-value \
            --secret-id ${GitHubPatSecretName} \
            --query SecretString \
            --output text \
            --region ${AWS::Region} | jq -r '.${GitHubPatSecretKey}')"

          # ? (∆–ƒ°) µ∑∫≈‰∏Æ∏¶ jenkins º“¿Ø/±««—¿∏∑Œ "√≥¿Ω∫Œ≈Õ" ª˝º∫ (¿Á∫Œ∆√/¿Áª˝º∫ø°µµ øµ±∏¿˚¿∏∑Œ µø¿œ)
          install -d -o jenkins -g jenkins -m 700 /var/lib/jenkins/secret-files
          printf '%s' "$PAT" > /var/lib/jenkins/secret-files/github_pat
          chown jenkins:jenkins /var/lib/jenkins/secret-files/github_pat
          chmod 600 /var/lib/jenkins/secret-files/github_pat

          unset PAT
          set -x

          # Í¥?Î¶¨Ïûê Í≥ÑÏ†ï ?ûê?èô ?Éù?Ñ±/Î≥¥Ïïà ?Ñ§?†ï
          mkdir -p /var/lib/jenkins/init.groovy.d
          cat >/var/lib/jenkins/init.groovy.d/01-security.groovy <<'GROOVY'
          import jenkins.model.*
          import hudson.security.*
          import jenkins.model.JenkinsLocationConfiguration

          def instance = Jenkins.get()

          def adminUser = "${JenkinsAdminUser}"
          def adminPass = "${JenkinsAdminPassword}"

          def realm = new HudsonPrivateSecurityRealm(false)
          if (realm.getUser(adminUser) == null) {
            realm.createAccount(adminUser, adminPass)
          }
          instance.setSecurityRealm(realm)

          def strategy = new FullControlOnceLoggedInAuthorizationStrategy()
          strategy.setAllowAnonymousRead(false)
          instance.setAuthorizationStrategy(strategy)

          def baseUrl = "${JenkinsBaseUrl}"
          if (baseUrl != null && baseUrl.trim().length() > 0) {
            def loc = JenkinsLocationConfiguration.get()
            loc.setUrl(baseUrl.trim())
            loc.save()
          }

          instance.save()
          GROOVY

          # Jenkins Credentials ¿⁄µø ª˝º∫ (Secret Text) - ID: github-pat-infra-push
          cat >/var/lib/jenkins/init.groovy.d/03-credentials.groovy <<'GROOVY'
          import jenkins.model.*
          import com.cloudbees.plugins.credentials.*
          import com.cloudbees.plugins.credentials.domains.*
          import com.cloudbees.plugins.credentials.common.StandardCredentials
          import org.jenkinsci.plugins.plaincredentials.impl.StringCredentialsImpl
          import hudson.util.Secret

          def id = "github-pat-infra-push"
          def desc = "GitHub PAT for pushing waguwagu-infra manifests"
          def f = new File("/var/lib/jenkins/secret-files/github_pat")

          if (!f.exists()) {
            println("[WARN] github_pat file not found. Skip creating credential.")
            return
          }

          def pat = f.text.trim()
          if (pat == null || pat.length() == 0) {
            println("[WARN] github_pat is empty. Skip creating credential.")
            return
          }

          def j = Jenkins.get()
          def provider = j.getExtensionList('com.cloudbees.plugins.credentials.SystemCredentialsProvider')[0]
          def store = provider.getStore()
          def domain = Domain.global()

          def existing = com.cloudbees.plugins.credentials.CredentialsProvider.lookupCredentials(
            StandardCredentials.class, j, null, null
          ).find { it.id == id }

          if (existing != null) {
            store.removeCredentials(domain, existing)
          }

          def c = new StringCredentialsImpl(CredentialsScope.GLOBAL, id, desc, Secret.fromString(pat))
          store.addCredentials(domain, c)
          println("[OK] Created/Updated credential: " + id)
          GROOVY

          # Job ?ûê?èô ?Éù?Ñ± (game-ci) + Poll SCM
          cat >/var/lib/jenkins/init.groovy.d/02-jobs.groovy <<'GROOVY'
          import jenkins.model.*
          import org.jenkinsci.plugins.workflow.job.WorkflowJob
          import org.jenkinsci.plugins.workflow.cps.CpsScmFlowDefinition
          import hudson.plugins.git.*
          import hudson.triggers.SCMTrigger

          def j = Jenkins.get()

          def repoUrl = "https://github.com/ms-waguwagu/waguwagu-server.git"
          def branchSpec = "*/main"

          def ensurePipelineJob = { String jobName, String scriptPath ->
            def existing = j.getItem(jobName)
            if (existing != null) {
              println("[OK] Job already exists: " + jobName)
              return
            }

            println("[CREATE] Job: " + jobName)

            WorkflowJob job = j.createProject(WorkflowJob, jobName)

            def remote = new UserRemoteConfig(repoUrl, null, null, null) // public repo -> credentialsId Î∂àÌïÑ?öî
            def scm = new GitSCM(
              [remote],
              [new BranchSpec(branchSpec)],
              false,
              [],
              null,
              null,
              []
            )

            job.definition = new CpsScmFlowDefinition(scm, scriptPath)

            // Poll SCM: 5Î∂ÑÎßà?ã§ Î≥?Í≤? Í∞êÏ??
            job.addTrigger(new SCMTrigger("H/2 * * * *"))

            job.save()
          }

          ensurePipelineJob("game-ci", "game-server/Jenkinsfile")
          j.save()
          GROOVY

          chown -R jenkins:jenkins /var/lib/jenkins/init.groovy.d

          systemctl start jenkins
          systemctl status jenkins --no-pager || true
          ss -lntp | grep 8080 || true
          wget -qS --spider http://localhost:8080/login || true

      Tags:
        - Key: Name
          Value: !Sub "${ProjectPrefix}-Jenkins-Game"
        - Key: Project
          Value: WAGUWAGU

Outputs:
  JenkinsInstanceMatchingId:
    Value: !Ref JenkinsInstanceMatching
    Description: Instance ID of the Jenkins Matching Server
    Export:
      Name: !Sub "${ProjectPrefix}-Jenkins-Matching-Instance-Id"

  JenkinsInstanceMatchingPublicIp:
    Value: !GetAtt JenkinsInstanceMatching.PublicIp
    Description: Public IP of the Jenkins Matching Server

  JenkinsInstanceGameId:
    Value: !Ref JenkinsInstanceGame
    Description: Instance ID of the Jenkins Game Server
    Export:
      Name: !Sub "${ProjectPrefix}-Jenkins-Game-Instance-Id"

  JenkinsInstanceGamePublicIp:
    Value: !GetAtt JenkinsInstanceGame.PublicIp
    Description: Public IP of the Jenkins Game Server
