apiVersion: "agones.dev/v1"
kind: Fleet
metadata:
  name: waguwagu-fleet
  namespace: game
  labels:
    app: waguwagu
spec:
  # Ready 또는 Allocated 상태로 유지할 GameServer 개수
  replicas: 10

  # 스케줄링 전략. 기본값은 Packed.
  scheduling: Packed

  # 템플릿 변경 시 교체 전략. 운영 안정성은 RollingUpdate가 기본값.
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%

  template:
    metadata:
      labels:
        app: waguwagu
        mode: room-per-pod
    spec:
      ports:
        - name: game
          portPolicy: Dynamic
          containerPort: 3001
          protocol: TCP # UDP/TCPUDP 가능
      health:
        disabled: false
        initialDelaySeconds: 10
        periodSeconds: 5
        failureThreshold: 3
      sdkServer:
        logLevel: Info
      template:
        spec:
          terminationGracePeriodSeconds: 30
          containers:
            - name: game-server
              image: 061039804626.dkr.ecr.ap-northeast-2.amazonaws.com/t3-wagu-game-server:latest # TODO: ECR 이미지로 변경
              imagePullPolicy: IfNotPresent
              ports:
                - containerPort: 3001
              env:
                - name: GAME_PORT
                  valueFrom:
                    secretKeyRef:
                      name: game-secret
                      key: GAME_PORT
                - name: DB_HOST
                  valueFrom:
                    secretKeyRef:
                      name: game-secret
                      key: DB_HOST
                - name: DB_PORT
                  valueFrom:
                    secretKeyRef:
                      name: game-secret
                      key: DB_PORT
                - name: DB_USER
                  valueFrom:
                    secretKeyRef:
                      name: game-secret
                      key: DB_USER
                - name: DB_NAME
                  valueFrom:
                    secretKeyRef:
                      name: game-secret
                      key: DB_NAME
                - name: DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: game-secret
                      key: DB_PASSWORD
              resources:
                requests:
                  cpu: "250m"
                  memory: "256Mi"
                limits:
                  cpu: "1000m"
                  memory: "1Gi"
