/* 하나 변경시 다 빌드되는 문제를 고쳐야 한다  */

pipeline {
  agent any

  environment {
    AWS_REGION   = "ap-northeast-2"

    // account id (팀 계정)
    ECR_REPO_URI = "269397878198.dkr.ecr.ap-northeast-2.amazonaws.com/t3-wagu-matching-server"

    // (옵션) 나중에 kubectl 배포까지 붙일 때 사용
    CLUSTER_NAME = "T3-Wagu-Matching-EKS"
    NAMESPACE    = "matching"
    DEPLOYMENT_NAME = "matching-deploy"
    CONTAINER_NAME  = "matching"

    // waguwagu-infra 쪽 설정
    INFRA_REPO_URL = "https://github.com/ms-waguwagu/waguwagu-infra.git"
    INFRA_BRANCH   = "main"
    INFRA_MANIFEST = "k8s/matching/matching-deploy.yaml"

    // Jenkins Credentials ID (Secret text: GitHub PAT)
    INFRA_CRED_ID  = "github-pat-infra-push"

    // commit author
    GIT_USER_NAME  = "jenkins-bot"
    GIT_USER_EMAIL = "jenkins@waguwagu.local"
  }

  options {
    skipDefaultCheckout(true)
    timestamps()
  }

  stages {
    stage("Checkout") {
      steps {
        checkout scm
      }
    }

    stage("Change check (matching-server only)") {
      steps {
        script {
          echo "=== MATCHING JENKINSFILE ==="

          // 변경된 파일 목록에서 matching-server/ 하위만 체크
          def changed = sh(
            script: "git diff --name-only HEAD~1..HEAD | grep -E '^matching-server/' || true",
            returnStdout: true
          ).trim()

          if (!changed) {
            echo "No changes in matching-server/. Skip Build/Push and Manifest update."
            currentBuild.result = 'SUCCESS'
            // 이후 stage들을 스킵하기 위해 플래그
            env.DO_BUILD = "false"
          } else {
            echo "Changes detected in matching-server/ -> proceed."
            env.DO_BUILD = "true"
          }
        }
      }
    }

    stage("ECR Login") {
      when { expression { return env.DO_BUILD == "true" } }
      steps {
        sh '''
          set -e
          aws ecr get-login-password --region "${AWS_REGION}" \
            | docker login --username AWS --password-stdin "${ECR_REPO_URI%/*}"
        '''
      }
    }

    stage("Build & Push") {
      when { expression { return env.DO_BUILD == "true" } }
      steps {
        script {
          def sha7 = sh(returnStdout: true, script: "git rev-parse --short=7 HEAD").trim()
          def tag  = "${sha7}-${env.BUILD_NUMBER}"
          env.IMAGE_TAG = tag
          env.IMAGE_URI = "${env.ECR_REPO_URI}:${tag}"
          echo "IMAGE_URI = ${env.IMAGE_URI}"
        }

        sh '''
          set -e
          cd matching-server
          docker build -t "${ECR_REPO_URI}:${IMAGE_TAG}" .
          docker push "${ECR_REPO_URI}:${IMAGE_TAG}"
        '''
      }
    }

    stage("Update waguwagu-infra manifest (commit/push)") {
      when { expression { return env.DO_BUILD == "true" } }
      steps {
        withCredentials([string(credentialsId: "${INFRA_CRED_ID}", variable: "GITHUB_PAT")]) {
          sh '''
            set -euo pipefail

            rm -rf infra
            mkdir -p infra

            # 커밋 작성자
            git config --global user.name  "${GIT_USER_NAME}"
            git config --global user.email "${GIT_USER_EMAIL}"

            # (중요) push 인증이 꼬이지 않도록 프롬프트/credential helper 영향 최소화
            git config --global --unset-all credential.helper >/dev/null 2>&1 || true
            git config --global credential.helper "" || true

            # push에만 토큰 사용 (로그 노출 방지)
            set +x
            PUSH_URL="https://x-access-token:${GITHUB_PAT}@github.com/ms-waguwagu/waguwagu-infra.git"
            set -x

            # clone은 일반 URL(읽기)
            git clone --branch "${INFRA_BRANCH}" "${INFRA_REPO_URL}" infra
            cd infra

            # origin의 push URL만 토큰 URL로 강제 (핵심)
            set +x
            git remote set-url --push origin "${PUSH_URL}"
            set -x

            echo "[BEFORE] image line:"
            grep -n "image:.*${ECR_REPO_URI}:" -n "${INFRA_MANIFEST}" || true

            # image 태그만 교체
            sed -i "s#\\(image:\\s*${ECR_REPO_URI}:\\).*#\\1${IMAGE_TAG}#g" "${INFRA_MANIFEST}"

            echo "[AFTER] image line:"
            grep -n "image:.*${ECR_REPO_URI}:" -n "${INFRA_MANIFEST}" || true

            # 변경 없으면 커밋/푸시 생략
            if git diff --quiet; then
              echo "No manifest change (already on ${IMAGE_TAG}). Skip commit/push."
              exit 0
            fi

            git add "${INFRA_MANIFEST}"
            git commit -m "ci(matching): bump image to ${IMAGE_TAG}"

            # push (토큰 URL로)
            GIT_TERMINAL_PROMPT=0 git push origin "${INFRA_BRANCH}"
          '''
        }
      }
    }
  }

  post {
    always {
      sh 'docker image prune -f || true'
    }
  }
}

/* 일단 주석 
pipeline {
  agent any

  environment {
    AWS_REGION   = "ap-northeast-2"

    // 내 account id 집어넣음
    ECR_REPO_URI = "061039804626.dkr.ecr.ap-northeast-2.amazonaws.com/t3-wagu-matching-server"

    CLUSTER_NAME = "T3-Wagu-Matching-EKS"
    NAMESPACE    = "matching"

    DEPLOYMENT_NAME = "matching-deploy"
    CONTAINER_NAME  = "matching"
  }

  options {
    skipDefaultCheckout(true)
    // (옵션) 중복 checkout 방지하고 싶으면 켜도 됨
    // skipDefaultCheckout(true)
  }

  stages {
    stage("Checkout") {
      steps {
        checkout scm
      }
    }

    // (선택) matching-server 폴더 변경 체크 (하지만 이제 스킵/중단 안 함)
    stage("Change check") {
      steps {
        script {
          echo "=== MATCHING JENKINSFILE TEST v1 ==="   // <- 이거 한 줄 추가해보기 테스트용도 실제 잘 polling되나
          def changed = sh(
            script: "git diff --name-only HEAD~1..HEAD | grep -E '^matching-server/' || true",
            returnStdout: true
          ).trim()

          //  변경이 없어도 빌드를 막지 말고 그냥 진행
          if (!changed) {
            echo "No changes in matching-server/, but continue (always Build & Push)."
          } else {
            echo "Changes detected in matching-server/ -> proceed."
          }
        }
      }
    }

    stage("ECR Login") {
      steps {
        sh '''
          set -e
          aws ecr get-login-password --region ${AWS_REGION} \
            | docker login --username AWS --password-stdin ${ECR_REPO_URI%/*}
        '''
      }
    }

    stage("Build & Push") {
      steps {
        script {
          // 태그 전략: 커밋해시, 빌드번호
          def sha7 = sh(returnStdout: true, script: "git rev-parse --short=7 HEAD").trim()
          def tag  = "${sha7}-${env.BUILD_NUMBER}"
          env.IMAGE_TAG = tag
          env.IMAGE_URI = "${env.ECR_REPO_URI}:${tag}"
        }

        sh '''
          set -e
          cd matching-server
          docker build -t ${ECR_REPO_URI}:${IMAGE_TAG} .
          docker push ${ECR_REPO_URI}:${IMAGE_TAG}
        '''
      }
    }

  
  }

  post {
    always {
      sh 'docker image prune -f || true'
    }
  }
}
*/




































/* 하나 변경시 다 빌드되는 오류를 고쳐야 한다 ..

*/